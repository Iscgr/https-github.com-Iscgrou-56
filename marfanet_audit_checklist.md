# چک‌لیست جامع نقاط ضعف و نیازمندی‌های فنی اپلیکیشن MarFaNet

این سند، خروجی رسمی "میزگرد تخصصی تحلیل عمیق و ممیزی اپلیکیشن MarFaNet" است. در این مستند، تمامی نقاط ضعف، موارد ناقص و نیازمندی‌های فنی که توسط شورای تخصصی شناسایی شده، به صورت یک چک‌لیست دقیق و قابل اقدام، مدون شده است. هدف از این چک‌لیست، ارائه یک نقشه راه شفاف برای ارتقای سیستم به سطح معماری ایده‌آل و بی‌نقص است.

---

### ۱. ماژول: صدور فاکتور دسته‌ای از طریق آپلود فایل

- [ ] **عدم وجود ردپای حسابرسی (Audit Trail):** مشخص نیست کدام فاکتورها به صورت دستی و کدام‌ها به صورت دسته‌ای ایجاد شده‌اند.
    - **راهکار:** افزودن ستون `source` و `batch_job_id` به جدول `Invoices`.

- [ ] **ریسک ایجاد فاکتورهای تکراری (عدم وجود Idempotency):** در صورت شکست و اجرای مجدد فرآیند، فاکتورهای تکراری برای ردیف‌های پردازش شده قبلی ایجاد می‌شود.
    - **راهکار:** ایجاد یک کلید یکتای پردازش (Idempotency Key) برای هر ردیف فایل (ترکیبی از `JobID` و هش ردیف) و بررسی آن قبل از ایجاد فاکتور.

- [ ] **عدم وجود مکانیزم بازگردانی (Rollback):** در صورت آپلود فایل اشتباه، هیچ راهکار ساده‌ای برای بازگرداندن گروهی فاکتورهای ایجاد شده وجود ندارد.
    - **راهکار:** پیاده‌سازی عملیات "ابطال دسته‌ای" (Bulk Cancellation) که وضعیت تمام فاکتورهای یک بچ را به `CANCELLED` تغییر دهد.

- [ ] **عدم مدیریت خطاهای گذرا (Transient Errors):** در صورت قطعی لحظه‌ای دیتابیس، فرآیند برای یک ردیف فوراً ناموفق می‌شود.
    - **راهکار:** پیاده‌سازی سیاست تلاش مجدد (Retry Policy) با فاصله زمانی فزاینده در پردازشگر صف (Worker).

- [ ] **ریسک توقف کل فرآیند به دلیل یک ردیف معیوب:** یک ردیف با داده‌های غیرمنتظره می‌تواند کل پردازش بچ را متوقف کند.
    - **راهکار:** استفاده از صف نامه‌های مرده (Dead-letter Queue - DLQ) برای انتقال ردیف‌های مکرراً ناموفق به یک صف مجزا جهت بررسی دستی.

- [ ] **کد تکراری برای پردازش فایل (عدم وجود ماژول عمومی):** منطق پارس کردن و اعتبارسنجی فایل در آینده برای سایر ماژول‌ها (مانند ایجاد دسته‌ای نمایندگان) تکرار خواهد شد.
    - **راهکار:** ایجاد یک سرویس عمومی و ماژولار به نام `DataImporterService` که قابل پیکربندی برای انواع داده‌ها باشد.

---

### ۲. ماژول: مدیریت نمایندگان (Agents)

- [ ] **کند بودن بارگذاری لیست نمایندگان:** محاسبه آنی خلاصه‌های مالی (موجودی، بدهی) برای لیست نمایندگان، با افزایش داده‌ها بسیار کند خواهد شد.
    - **راهکار:** پیاده‌سازی الگوی CQRS با استفاده از یک جدول خلاصه‌ساز (`AgentFinancialSummaries`) که در پس‌زمینه و توسط رویدادها (Events) به‌روز می‌شود.

- [ ] **ابهام در منبع حقیقت داده (Source of Truth):** ریسک استفاده از داده‌های خلاصه‌سازی شده (که ممکن است کهنه باشند) برای گزارش‌های رسمی.
    - **راهکار:** تعریف قانون معماری: جدول خلاصه‌ها **فقط برای نمایش در UI** است. تمام گزارش‌های رسمی باید مستقیماً از جداول اصلی استعلام شوند.

- [ ] **عدم وجود مکانیزم مغایرت‌گیری:** در صورت از دست رفتن یک رویداد، داده‌های جدول خلاصه‌ها با داده‌های واقعی مغایرت پیدا خواهد کرد.
    - **راهکار:** ایجاد یک ابزار ادمین برای "بازسازی کامل" (Full Rebuild) جدول خلاصه‌ها از روی داده‌های اصلی.

- [ ] **ریسک از دست رفتن رویدادها:** در صورت کرش کردن پردازشگر رویداد (Listener)، رویداد از بین رفته و خلاصه‌های مالی برای همیشه اشتباه باقی می‌مانند.
    - **راهکار:** استفاده از یک صف پایدار مبتنی بر دیتابیس (`EventQueue`) به جای `EventEmitter` درون-حافظه‌ای، همراه با مکانیزم DLQ برای رویدادهای ناموفق.

- [ ] **عدم اطلاع کاربر از تأخیر در همگام‌سازی (Eventual Consistency):** کاربر متوجه تأخیر چند ثانیه‌ای در به‌روزرسانی خلاصه‌های مالی پس از یک عملیات نمی‌شود.
    - **راهکار:** استفاده از یک انیمیشن ظریف (مانند پالس یا درخشش) در UI برای ردیف مربوطه جهت القای حس "در حال به‌روزرسانی".

---

### ۳. ماژول: مدیریت سرشاخه‌ها (Partners) و محاسبه پورسانت

- [ ] **فشار زیاد بر دیتابیس اصلی:** اجرای کوئری‌های تحلیلی سنگین برای محاسبه پورسانت، عملکرد تراکنش‌های زنده سیستم را مختل می‌کند.
    - **راهکار:** هدایت تمام کوئری‌های گزارش‌گیری و تحلیلی به یک **دیتابیس خواندنی ثانویه (Read Replica)**.

- [ ] **عدم وجود مکانیزم تعدیلات (Clawback):** در صورت بازگشت وجه (Refund) یک پرداخت که قبلاً در محاسبه پورسانت لحاظ شده، سیستم قادر به اصلاح خودکار نیست.
    - **راهکار:** ایجاد یک سیستم تعدیلات (`CommissionAdjustments`) مبتنی بر رویداد که بازگشت وجه‌ها را شناسایی و یک رکورد تعدیل منفی برای دوره محاسبه بعدی ایجاد کند.

- [ ] **عدم شفافیت کامل در محاسبه:** حسابرس نمی‌تواند لیست دقیق فاکتورهای مبنای محاسبه را برای آرشیو استخراج کند.
    - **راهکار:** ارائه قابلیت "خروجی اکسل" در صفحه جزئیات هر سند پورسانت.

- [ ] **امکان تغییر اسناد مالی پس از تایید:** اسناد پورسانت پس از تایید نهایی، قفل نیستند و قابل تغییر یا حذف می‌باشند.
    - **راهکار:** پیاده‌سازی State Machine که اسناد تایید شده را به صورت منطقی "قفل" (Immutable) کند و هرگونه اصلاح بعدی فقط از طریق سند تعدیل امکان‌پذیر باشد.

- [ ] **معماری نامناسب سرویس:** منطق محاسبه پورسانت با منطق مدیریت سرشاخه‌ها ترکیب شده که خلاف اصل Single Responsibility است.
    - **راهکار:** ایجاد یک سرویس کاملاً مجزا به نام `CommissionService`.

---

### ۴. ماژول: چرخه حیات و مدیریت فاکتورها (Invoices)

- [ ] **عدم وجود تاریخچه وضعیت فاکتور:** امکان ردیابی اینکه یک فاکتور در چه زمانی و توسط چه کسی یا چه فرآیندی تغییر وضعیت داده، وجود ندارد.
    - **راهکار:** ایجاد جدول `InvoiceStatusHistory` که هر تغییر وضعیت را به همراه زمان و عامل تغییر ثبت کند.

- [ ] **ریسک ارسال یادآورهای مکرر (عدم وجود Idempotency):** اجرای مجدد Cron Job می‌تواند منجر به ارسال چندین ایمیل یادآور برای یک فاکتور در یک روز شود.
    - **راهکار:** ایجاد یک جدول `NotificationLogs` و بررسی آن قبل از ارسال هر یادآور برای جلوگیری از ارسال‌های تکراری در یک بازه زمانی مشخص (مثلاً ۲۴ ساعت).

- [ ] **شکنندگی فرآیند خودکار:** شکست در ارسال یک نوتیفیکیشن (مثلاً به دلیل قطعی سرویس ایمیل) می‌تواند کل فرآیند به‌روزرسانی وضعیت فاکتورها را متوقف کند.
    - **راهکار:** مدیریت خطا به ازای هر فاکتور در حلقه Cron Job. ارسال‌های ناموفق باید لاگ شده و جاب به کار خود ادامه دهد.

- [ ] **منطق پراکنده برای تغییر وضعیت:** ریسک اینکه بخش‌های مختلف کد مستقیماً وضعیت فاکتور را تغییر دهند و یکپارچگی داده از بین برود.
    - **راهکار:** متمرکز کردن تمام منطق تغییر وضعیت در `InvoiceService` و جلوگیری از دسترسی مستقیم به ستون `status`.

---

### ۵. ماژول: مدیریت پرداخت‌ها (Payments)

- [ ] **عدم تفکیک پرداخت‌های داخلی و خارجی:** پرداخت‌هایی که از محل اعتبار داخلی نماینده انجام می‌شود، از واریزهای نقدی واقعی قابل تفکیک نیستند و گزارش‌های مالی را مخدوش می‌کنند.
    - **راهکار:** ایجاد یک نوع پرداخت مجزا `INTERNAL_SETTLEMENT` که ساختار متفاوتی داشته و به واریز اولیه ارجاع می‌دهد.

- [ ] **عدم وجود فرآیند بازگشت تسویه (Settlement Reversal):** در صورت نیاز به بازگرداندن یک واریز اولیه، هیچ راهکار خودکاری برای بازگرداندن وضعیت فاکتورهای تسویه شده با آن وجود ندارد.
    - **راهکار:** ایجاد یک فرآیند خودکار مبتنی بر رویداد که تسویه‌های داخلی مرتبط را شناسایی، تراکنش‌های معکوس ایجاد و وضعیت فاکتورها را مجدداً محاسبه کند.

- [ ] **ریسک بالای همزمانی (Race Condition):** اجرای همزمان فرآیند تسویه خودکار برای یک نماینده می‌تواند منجر به محاسبات اشتباه و وضعیت ناهماهنگ داده‌ها شود.
    - **راهکار:** استفاده از قفل‌گذاری بدبینانه (`SELECT ... FOR UPDATE`) روی موجودی نماینده در حین عملیات تسویه.

- [ ] **شکنندگی فرآیند تسویه در حلقه طولانی:** شکست در میانه حلقه تسویه برای نماینده‌ای با صدها فاکتور، سیستم را در وضعیت ناهماهنگ قرار می‌دهد.
    - **راهکار:** پیاده‌سازی فرآیند تسویه به صورت قابل از سرگیری (Resumable) با پردازش فاکتورها در بچ‌های کوچک و ثبت پیشرفت در یک جدول مجزا.

- [ ] **معماری نامناسب سرویس:** ترکیب منطق مدیریت کیف پول با سرویس پرداخت یا تسویه.
    - **راهکار:** ایجاد یک سرویس اختصاصی `WalletService` برای مدیریت تمام عملیات‌های مربوط به موجودی و اعتبار.

---

### ۶. ماژول: گزارش‌ها (Reports) و تنظیمات (Settings)

- [ ] **عدم وجود حسابرسی برای تغییرات تنظیمات:** مشخص نیست چه کسی، چه زمانی، کدام تنظیمات حیاتی سیستم را تغییر داده است.
    - **راهکار:** ایجاد یک جدول `SettingsAuditLog` برای ثبت تمام تغییرات در تنظیمات.

- [ ] **ریسک داده‌های کهنه به دلیل کش:** تغییر یک تنظیم مهم (مانند درصد مالیات) ممکن است به دلیل کش شدن تا دقایقی بعد در سیستم اعمال نشود.
    - **راهکار:** پیاده‌سازی مکانیزم **ابطال کش فوری (Instant Cache Invalidation)** با استفاده از Redis Pub/Sub.

- [ ] **عدم شفافیت در مورد تازگی داده‌های گزارش:** کاربر نمی‌داند گزارشی که مشاهده می‌کند بر اساس داده‌های چه زمانی است.
    - **راهکار:** نمایش زمان آخرین همگام‌سازی دیتابیس Read Replica به صورت واضح در بالای هر گزارش.

- [ ] **نبود کنترل کافی بر تغییر تنظیمات حساس:** تنظیمات حیاتی مانند درصد مالیات به سادگی قابل تغییر هستند.
    - **راهکار:** ارسال نوتیفیکیشن خودکار به مدیران سیستم پس از هر تغییر در تنظیمات حساس.

- [ ] **ریسک Timeout و فشار بر سیستم با گزارش‌های سنگین:** کاربران می‌توانند گزارش‌هایی با بازه‌های زمانی بسیار طولانی درخواست کنند.
    - **راهکار:** اعمال محدودیت روی حداکثر بازه زمانی قابل انتخاب در UI و تنظیم `statement_timeout` در سطح دیتابیس برای جلوگیری از کوئری‌های فراری.
