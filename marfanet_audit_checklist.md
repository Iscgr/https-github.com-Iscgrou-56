# MarFaNet Audit Checklist

این سند خروجی فاز شناخت و ارزیابی اولیه است و به عنوان ورودی مرحلهٔ دیباگ و طراحی استفاده خواهد شد.

## وضعیت ساخت و اجرا
- [x] `npm install`
- [x] `npm run build`
- [x] `npm run dev` (راه‌اندازی روی پورت ۹۰۰۲، سپس متوقف شد)
- [x] `npm test`

## لایهٔ ارائه (Presentation)
- [x] `src/app/portal/[agentId]/_components/portal-client-page.tsx` فیلدهایی مثل `agent.avatarUrl` و `agent.contact` را استفاده می‌کند که در `Agent` و داده‌های موجود تعریف نشده‌اند؛ صفحهٔ عمومی نماینده با خطا مواجه می‌شود.
- [x] `src/app/(dashboard)/payments/page.tsx` از `invoice.invoiceNumber` و `payment.referenceNumber` استفاده می‌کند که در مدل و دیتاست وجود ندارند؛ جست‌وجو/نمایش شمارهٔ فاکتور عملاً خالی می‌ماند.
- [x] منوی کناری داشبورد در `src/app/(dashboard)/layout.tsx` فقط زمانی آیتم را فعال می‌کند که آدرس دقیقاً برابر باشد؛ مسیرهای تودرتو (مثلاً `/agents/agent_1`) بدون حالت فعال باقی می‌مانند.
- [x] جدول فاکتورها در `src/app/(dashboard)/invoices/_components/invoice-table.tsx` از کامپوننت `<Badge>` استفاده می‌کند اما آن را ایمپورت نکرده است؛ در محیطی که بررسی TypeScript غیرفعال نباشد بیلد می‌شکند.

## لایهٔ برنامه‌کاربردی (Application / Server Actions)
- [x] اکشن `saveAgentAction` در `src/app/(dashboard)/agents/actions.ts` تابع `getAllAgentIds` را ایمپورت می‌کند در حالی که در `src/lib/data.ts` تعریف نشده است؛ فراخوانی این ماژول با خطای اجرا روبه‌رو می‌شود.
- [x] ابزار ادمین `rebuildSummariesAction` به تابع شِبه‌سازی‌شده‌ی `rebuildAllSummaries` متکی است که خالی است؛ بازسازی تجمیع مالی در عمل انجام نمی‌شود.
- [x] اکشن بارگذاری فاکتور (`uploadInvoicesAction`) هنگام ساخت رکورد جدید، `createIdempotentInvoice` را با دو آرگومان فراخوانی می‌کند درحالی‌که پیاده‌سازی فعلی تنها یک پارامتر می‌پذیرد و هیچ کلید شناسهٔ تکراری نیز ذخیره نمی‌شود.
- [x] همان اکشن فیلدهایی مانند `agentName`, `items`, `source`, `batchJobId` را روی آبجکت فاکتور ست می‌کند که در نوع `Invoice` تعریف نشده‌اند؛ با فعال بودن بررسی نوع، کامپایلر خطا می‌دهد و در زمان اجرا داده‌ها ناهماهنگ می‌مانند.

## لایهٔ منطق کسب‌وکار (Business Logic)
- [x] در `WalletService.settleInvoices` اگر موجودی کمتر از مبلغ فاکتور باشد، باز هم `InvoiceService.changeStatus` فاکتور را «paid» می‌کند؛ تسویهٔ جزئی به‌درستی مدیریت نشده و باعث ناهماهنگی می‌شود.
- [x] تاریخچهٔ وضعیت فاکتورها در `src/lib/invoice-service.ts` در آرایهٔ درون‌حافظه‌ای `invoiceStatusHistory` ذخیره می‌شود؛ با ری‌استارت شدن برنامه تمام لاگ‌ها از دست می‌رود و ردیابی ممیزی ممکن نیست.
- [x] سرویس کران (`src/lib/cron-service.ts`) در لاگ‌ها و نوتیفیکیشن‌ها از `invoice.invoiceNumber` استفاده می‌کند که در مدل وجود ندارد؛ پیام‌های ارسالی و لاگ‌ها ناقص می‌شوند.
- [x] `PaymentService.processPaymentTransaction` بین واریز وجه و تسویه فاکتورها تراکنش اتمیک ندارد؛ اگر تسویه شکست بخورد، پول در کیف باقی می‌ماند اما فاکتور بدون تغییر می‌ماند.

## لایهٔ دامنه (Domain Models)
- [x] نوع `AgentFinancialSummary` که در صفحات و جدول نمایندگان استفاده می‌شود در `src/lib/types.ts` تعریف نشده است؛ در محیطی با بررسی نوع، بیلد متوقف می‌شود.
- [x] ساختار داده‌های فرضی در `src/lib/data.ts` با نیازهای رابط تطابق ندارد (نبود `invoiceNumber`، `referenceNumber`، فیلدهای تماس نماینده و ...).
- [x] انواعی مانند `SystemSetting`, `SettingsAuditLog`, `NotificationLog` که در سرویس‌های تنظیمات و کران مصرف می‌شوند در `types.ts` تعریف نشده‌اند؛ اتکای فعلی فقط به `ignoreBuildErrors` است.

## لایهٔ زیرساخت (Infrastructure / Persistence)
- [x] تابع `createIdempotentInvoice` در `src/lib/data.ts` فقط رکورد جدید اضافه می‌کند و هیچ مکانیسم واقعی برای جلوگیری از دوباره‌کاری ندارد؛ Idempotency صرفاً اسمی است.
- [x] کل فضای داده (`agents`, `invoices`, `wallets`, ...) به‌صورت آرایه‌های in-memory نگه‌داری می‌شود؛ با هر ری‌استارت محیط توسعه تمام اطلاعات از دست می‌رود و سناریوهای پایداری قابل آزمون نیست.
- [x] سامانهٔ تنظیمات (`src/lib/settings-service.ts`) مقادیر حساس را به‌صورت متن ساده نگه می‌دارد و هیچ کانال کش/رمزنگاری یا کنترل دسترسی ندارد؛ با وجود فلگ `isSensitive` هنوز ریسک افشا بالاست.
- [x] جریان Genkit برای تجمیع مصرف فقط مقادیر `processedHashes` را در ورودی می‌گیرد و نگه‌داری دائمی ندارد؛ در خط لولهٔ واقعی تکرار داده‌ها دوباره پردازش خواهد شد مگر اینکه لایهٔ ذخیره‌سازی تکمیل شود.

---
این چک‌لیست در هر فاز بعدی باید به‌روزرسانی شود تا وضعیت رسیدگی به هر مورد مشخص بماند.
